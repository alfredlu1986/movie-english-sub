<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie English Sub / CSV / DOCX â€” Viewer + Search + Directory (Stable)</title>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--brand:#2563eb;--brand2:#1d4ed8}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:20px}
    h1{margin:0 0 6px;font-size:20px}
    h2{margin:0 0 8px;font-size:16px}
    .sub{margin:0 0 12px;color:var(--muted)}
    .grid{display:grid;gap:12px}
    @media(min-width:1024px){.layout{grid-template-columns:320px 1fr}}
    label{display:block;font-weight:600;font-size:13px;margin:6px 0 4px}
    input,select,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px}
    button{border:none;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:var(--brand2)}
    .tools{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .tools>*{flex:1}
    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    .status .error{color:#b91c1c;font-weight:700}
    .result{margin-top:14px;border-top:1px solid var(--line);padding-top:12px;overflow:auto}
    table{border-collapse:collapse;width:100%;font-size:14px}
    th,td{border:1px solid var(--line);padding:6px 8px;vertical-align:top}
    th{background:#f1f5f9}
    pre{white-space:pre-wrap;margin:0;background:#0f172a;color:#e5e7eb;padding:8px;border-radius:8px}
    mark{padding:0 2px;border-radius:3px}
    .tree{max-height:70vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:8px}
    .tree ul{list-style:none;margin:0;padding-left:14px}
    .tree li{margin:2px 0}
    .node{display:flex;align-items:center;gap:6px}
    .toggle{border:none;background:transparent;cursor:pointer;font-size:14px;line-height:1;padding:2px 4px}
    .fname{cursor:pointer}
    .fname.file{color:#0ea5e9}
    .badge{font-size:10px;border:1px solid var(--line);border-radius:6px;padding:0 6px;color:#475569;margin-left:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Movie English Sub / Words Viewer â€” Stable</h1>
      <p class="sub">è®€å– <b>.srt / .csv / .docx</b>ã€é—œéµå­—æœå°‹ï¼ˆé«˜äº®/éæ¿¾ï¼‰ï¼‹ å·¦å´ç›®éŒ„é»è®€ã€‚é è¨­ï¼š<code>alfredlu1986/movie-english-sub@main</code></p>

      <div class="grid" style="grid-template-columns:1.3fr 1fr 1fr;gap:12px">
        <div>
          <label>Owner</label>
          <input id="owner" value="alfredlu1986" />
        </div>
        <div>
          <label>Repo</label>
          <input id="repo" value="movie-english-sub" />
        </div>
        <div>
          <label>Branch</label>
          <input id="branch" value="main" />
        </div>
      </div>

      <div class="grid layout" style="margin-top:16px">
        <!-- ç›®éŒ„æ¨¹ -->
        <div class="card">
          <h2>ç›®éŒ„ / æª”æ¡ˆç€è¦½</h2>
          <div class="tools">
            <input id="treePath" placeholder="å¾æ­¤è·¯å¾‘è¼‰å…¥ï¼ˆç•™ç©º=æ ¹ç›®éŒ„ï¼Œä¾‹å¦‚ 1999/ï¼‰ã€ />
            <button id="treeLoad">è¼‰å…¥ç›®éŒ„</button>
          </div>
          <div class="tools">
            <input id="nameFilter" placeholder="æª”åéæ¿¾ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰ã€ />
          </div>
          <div class="tools">
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showSRT" checked>.srt</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showCSV" checked>.csv</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showDOCX" checked>.docx</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showOTHER">å…¶ä»–</label>
          </div>
          <div id="treeStatus" class="status"></div>
          <div class="tree"><ul id="treeRoot"></ul></div>
        </div>

        <!-- æª¢è¦–/æœå°‹ -->
        <div class="card">
          <h2>æª”æ¡ˆæª¢è¦– & æœå°‹</h2>
          <div class="grid" style="grid-template-columns:1fr 200px auto;gap:10px">
            <div>
              <label>æª”æ¡ˆè·¯å¾‘ï¼ˆç›¸å°æ–¼ repo rootï¼‰</label>
              <input id="path" placeholder="ä¾‹å¦‚ï¼šEnWords.csv æˆ– 1999/movie.srt æˆ– docs/sample.docx" />
            </div>
            <div>
              <label>æª”æ¡ˆé¡å‹</label>
              <select id="fileType">
                <option value="srt">SRT (.srt)</option>
                <option value="csv">CSV (.csv)</option>
                <option value="docx">DOCX (.docx)</option>
              </select>
            </div>
            <div style="align-self:end">
              <button id="loadBtn">è¼‰å…¥æª”æ¡ˆ</button>
            </div>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr auto;gap:10px;margin-top:8px">
            <div>
              <label>é—œéµå­—æœå°‹ï¼ˆå³æ™‚ï¼‰</label>
              <input id="q" placeholder="è¼¸å…¥é—œéµå­—â€¦" />
              <div class="status">SRT/CSV å¯ã€Œåªé¡¯ç¤ºç¬¦åˆã€ï¼›DOCX ç‚ºå…¨æ–‡é«˜äº®</div>
            </div>
            <div>
              <label>æœå°‹é¸é …</label>
              <div class="tools">
                <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="matchCase">å¤§å°å¯«ç›¸ç¬¦</label>
                <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="wholeWord">å…¨å­—æ¯”å°</label>
                <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="filterRows">åªé¡¯ç¤ºç¬¦åˆï¼ˆSRT/CSVï¼‰</label>
              </div>
            </div>
            <div style="align-self:end;display:flex;gap:8px">
              <button id="searchBtn">æœå°‹/é«˜äº®</button>
              <button id="clearBtn" style="background:#334155">æ¸…é™¤</button>
            </div>
          </div>

          <div id="status" class="status"></div>
          <div id="counts" class="status"></div>
          <div id="result" class="result"></div>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== Helpers
const $ = id => document.getElementById(id);
const ownerEl = $("owner"), repoEl=$("repo"), branchEl=$("branch");
const pathEl=$("path"), typeEl=$("fileType"), loadBtn=$("loadBtn");
const qEl=$("q"), matchCaseEl=$("matchCase"), wholeWordEl=$("wholeWord"), filterRowsEl=$("filterRows");
const searchBtn=$("searchBtn"), clearBtn=$("clearBtn");
const statusEl=$("status"), countsEl=$("counts"), resultEl=$("result");
const treeRoot=$("treeRoot"), treeStatus=$("treeStatus"), treeLoad=$("treeLoad"), treePathEl=$("treePath");
const showSRT=$("showSRT"), showCSV=$("showCSV"), showDOCX=$("showDOCX"), showOTHER=$("showOTHER"), nameFilter=$("nameFilter");

function rawBase(){
  const o=ownerEl.value.trim()||"alfredlu1986";
  const r=repoEl.value.trim()||"movie-english-sub";
  const b=branchEl.value.trim()||"main";
  return {o,r,b,url:`https://raw.githubusercontent.com/${o}/${r}/${b}/`};
}
function apiBase(){
  const o=ownerEl.value.trim()||"alfredlu1986";
  const r=repoEl.value.trim()||"movie-english-sub";
  const b=branchEl.value.trim()||"main";
  return {o,r,b,url:`https://api.github.com/repos/${o}/${r}/contents/`,ref:b};
}
function escapeHtml(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&');}
function buildRegex(query){
  if(!query) return null;
  const src = wholeWordEl.checked ? `\\b${escapeRegExp(query)}\\b` : escapeRegExp(query);
  return new RegExp(src, matchCaseEl.checked? 'g' : 'gi');
}
function countMatches(str, re){
  if(!re) return 0; const r = new RegExp(re.source, re.flags);
  const m = String(str).match(r); return m? m.length : 0;
}
function extOf(name){const m = (name||'').toLowerCase().match(/\.([a-z0-9]+)$/); return m?m[1]:'';}
function showByExt(name){const e=extOf(name); if(e==='srt')return showSRT.checked; if(e==='csv')return showCSV.checked; if(e==='docx')return showDOCX.checked; return showOTHER.checked;}

// ===== Directory tree
async function fetchDir(path){
  const {url,ref}=apiBase();
  const api = url + encodeURIComponent(path||'').replace(/%2F/g,'/') + ((path && path.endsWith('/'))?'':'') + `?ref=${encodeURIComponent(ref)}`;
  const res = await fetch(api); if(!res.ok) throw new Error(`GitHub API ${res.status}`);
  const data = await res.json(); if(!Array.isArray(data)) throw new Error('éç›®éŒ„æˆ–è·¯å¾‘ä¸å­˜åœ¨');
  data.sort((a,b)=> (a.type===b.type? a.name.localeCompare(b.name) : (a.type==='dir'?-1:1)));
  return data;
}

function renderClosedFolder(fullPath){
  const li=document.createElement('li'); li.className='node dir';
  const head=document.createElement('div'); head.className='node';
  const btn=document.createElement('button'); btn.className='toggle'; btn.textContent='â–¸';
  const span=document.createElement('span'); span.className='fname'; span.textContent='ğŸ“ '+fullPath.split('/').pop();
  head.appendChild(btn); head.appendChild(span); li.appendChild(head);
  const ul=document.createElement('ul'); ul.className='hidden'; li.appendChild(ul);
  let loaded=false, collapsed=true;
  async function expand(){
    if(!loaded){
      try{ const kids=await fetchDir(fullPath); for(const ent of kids){ (ent.type==='dir')? ul.appendChild(renderClosedFolder(ent.path)) : ul.appendChild(renderFile(ent.path, ent.name)); }
        loaded=true; applyTreeFilters();
      }catch(e){ const errLi=document.createElement('li'); errLi.innerHTML=`<span class="status">ç„¡æ³•è®€å–ï¼š${escapeHtml(e.message||String(e))}</span>`; ul.appendChild(errLi); }
    }
    collapsed=false; btn.textContent='â–¾'; ul.classList.remove('hidden');
  }
  function collapse(){collapsed=true; btn.textContent='â–¸'; ul.classList.add('hidden');}
  btn.addEventListener('click', ()=> collapsed?expand():collapse());
  span.addEventListener('click', ()=> collapsed?expand():collapse());
  return li;
}
function renderFile(fullPath,name){
  const li=document.createElement('li'); li.className='node file'; li.dataset.fullPath=fullPath;
  const row=document.createElement('div'); row.className='node';
  const a=document.createElement('a'); a.href='#'; a.className='fname file'; a.textContent='ğŸ“„ '+name; a.title=fullPath;
  const badge=document.createElement('span'); badge.className='badge'; badge.textContent=extOf(name)||'file';
  row.appendChild(a); row.appendChild(badge); li.appendChild(row);
  a.addEventListener('click', e=>{e.preventDefault(); openFileFromTree(fullPath,name);});
  return li;
}
function renderDirNode(path, entries){
  const li=document.createElement('li'); li.className='node dir';
  const header=document.createElement('div'); header.className='node';
  const btn=document.createElement('button'); btn.className='toggle'; btn.textContent='â–¾';
  const span=document.createElement('span'); span.className='fname'; span.textContent='ğŸ“ '+(path||'/');
  header.appendChild(btn); header.appendChild(span); li.appendChild(header);
  const ul=document.createElement('ul'); li.appendChild(ul);
  for(const ent of entries){ (ent.type==='dir')? ul.appendChild(renderClosedFolder(ent.path)) : ul.appendChild(renderFile(ent.path, ent.name)); }
  let collapsed=false; btn.addEventListener('click',()=>{collapsed=!collapsed; btn.textContent=collapsed?'â–¸':'â–¾'; ul.classList.toggle('hidden',collapsed)});
  return li;
}
async function loadTree(path){
  treeStatus.textContent='è®€å–ä¸­â€¦'; treeRoot.innerHTML='';
  try{ const root=await fetchDir(path||''); treeRoot.appendChild(renderDirNode(path||'/', root)); treeStatus.textContent='å®Œæˆã€‚é»è³‡æ–™å¤¾å±•é–‹/æ”¶åˆï¼Œé»æª”æ¡ˆå³è¼‰å…¥ã€‚'; applyTreeFilters(); }
  catch(e){ treeStatus.innerHTML=`<span class="error">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(e.message||String(e))}</span>`; }
}
function applyTreeFilters(){
  const q=(nameFilter.value||'').toLowerCase(); const items=treeRoot.querySelectorAll('li.node.file');
  items.forEach(li=>{ const name=li.querySelector('.fname').textContent.toLowerCase(); const okExt=showByExt(name); const okName=!q || name.includes(q); li.style.display=(okExt&&okName)?'':''; });
}
function openFileFromTree(fullPath,name){ pathEl.value=fullPath; const e=extOf(name); typeEl.value=(e==='srt'||e==='csv'||e==='docx')?e:'srt'; loadFile(); }

treeLoad.addEventListener('click',()=>loadTree(treePathEl.value.trim()));
ownerEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
repoEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
branchEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
[nameFilter,showSRT,showCSV,showDOCX,showOTHER].forEach(el=> el.addEventListener('input', applyTreeFilters));

// ===== File renderers
let lastType=null; let srtEntries=[]; let csvData={header:[],rows:[]}; let docxHtmlOriginal='';

function highlightText(text, re){
  if(!re || text==null) return escapeHtml(text);
  const s=String(text); let out=''; let last=0; const r=new RegExp(re.source, re.flags);
  let m; while((m=r.exec(s))){ out += escapeHtml(s.slice(last, m.index)); out += `<mark>${escapeHtml(m[0])}</mark>`; last = m.index + m[0].length; if(!r.global) break; }
  out += escapeHtml(s.slice(last)); return out;
}

function parseSrt(text){
  const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const blocks = norm.split(/\n{2,}/);
  const entries=[];
  for(const b of blocks){ const lines=b.trim().split('\n'); if(!lines[0]) continue; let idx=lines[0].trim(), timeLine='', textLines=[];
    if(/^\d+$/.test(idx) && lines.length>=2){ timeLine=lines[1].trim(); textLines=lines.slice(2); } else { idx=''; timeLine=lines[0].trim(); textLines=lines.slice(1); }
    let start='', end=''; const m=timeLine.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/); if(m){ start=m[1]; end=m[2]; }
    entries.push({index:idx,start,end,text:textLines.join('\n')}); }
  return entries;
}
function renderSrt(entries, re){
  let html = '<table><thead><tr><th>#</th><th>Start</th><th>End</th><th>Text</th></tr></thead><tbody>';
  for(const e of entries){ html += `<tr><td>${escapeHtml(e.index||'')}</td><td>${escapeHtml(e.start)}</td><td>${escapeHtml(e.end)}</td><td><pre>${re?highlightText(e.text,re):escapeHtml(e.text)}</pre></td></tr>`; }
  html += '</tbody></table>'; resultEl.innerHTML=html;
}

function parseCsv(text){
  const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  let lines = norm.split('\n');
  // drop empty trailing lines but keep intentional blanks inside
  while(lines.length && lines[lines.length-1].trim()==='') lines.pop();
  if(lines.length && lines[0].charCodeAt(0)===65279) lines[0]=lines[0].slice(1); // BOM
  if(!lines.length) return {header:[],rows:[]};
  const header = splitCsvLine(lines[0]);
  const rows = lines.slice(1).map(splitCsvLine);
  return {header, rows};
}
function splitCsvLine(line){
  const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(inQ){ if(ch==='"'){ if(i+1<line.length && line[i+1]=='"'){ cur+='"'; i++; } else inQ=false; }
            else cur+=ch; }
    else { if(ch==='"') inQ=true; else if(ch===','){ out.push(cur); cur=''; } else cur+=ch; }
  }
  out.push(cur); return out;
}
function renderCsv(header, rows, re){
  let html = '<table><thead><tr>'+header.map(h=>`<th>${escapeHtml(h)}</th>`).join('')+'</tr></thead><tbody>';
  for(const row of rows){ html += '<tr>' + header.map((_,i)=>{const cell = row[i]??''; return `<td>${re?highlightText(cell,re):escapeHtml(cell)}</td>`;}).join('') + '</tr>'; }
  html += '</tbody></table>'; resultEl.innerHTML=html;
}

function restoreDocx(){ resultEl.innerHTML = docxHtmlOriginal; }
function highlightInElement(root, re){ if(!re) return 0; let cnt=0; const walker=document.createTreeWalker(root, NodeFilter.SHOW_TEXT); const nodes=[]; while(walker.nextNode()) nodes.push(walker.currentNode);
  for(const node of nodes){ const s=node.nodeValue; const r=new RegExp(re.source, re.flags); if(!r.test(s)) continue; r.lastIndex=0; const frag=document.createDocumentFragment(); let last=0; let m; while((m=r.exec(s))){ if(m.index>last) frag.appendChild(document.createTextNode(s.slice(last,m.index))); const mark=document.createElement('mark'); mark.textContent=m[0]; frag.appendChild(mark); last=m.index+m[0].length; cnt++; if(!r.global) break; } if(last<s.length) frag.appendChild(document.createTextNode(s.slice(last))); node.parentNode.replaceChild(frag,node); }
  return cnt;
}

// ===== Load + Search
async function loadFile(){
  const rel=(pathEl.value||'').trim(); if(!rel){ statusEl.innerHTML='<span class="error">è«‹è¼¸å…¥æª”æ¡ˆè·¯å¾‘ã€‚</span>'; return; }
  const base=rawBase(); const full=encodeURI(base.url + rel);
  let type=typeEl.value; const ext=extOf(rel); if(ext==='srt'||ext==='csv'||ext==='docx') type=ext;
  statusEl.textContent = `è¼‰å…¥ä¸­ï¼š${full}`; countsEl.textContent=''; resultEl.innerHTML='';
  try{
    if(type==='docx'){ await loadDocx(full); }
    else { await loadTextFile(full, type); }
    const ghUrl=`https://github.com/${base.o}/${base.r}/blob/${base.b}/${rel}`;
    statusEl.innerHTML = `è¼‰å…¥å®Œæˆï¼š<a href="${full}" target="_blank" rel="noopener">Raw</a> Â· <a href="${ghUrl}" target="_blank" rel="noopener">GitHub</a>`;
    doSearch();
  }catch(e){ statusEl.innerHTML=`<span class="error">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(e.message||String(e))}</span>`; }
}

async function loadTextFile(url, type){
  const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text=await res.text();
  if(type==='srt'){ lastType='srt'; srtEntries=parseSrt(text); renderSrt(srtEntries); }
  else if(type==='csv'){ lastType='csv'; csvData=parseCsv(text); renderCsv(csvData.header, csvData.rows); }
}
async function loadDocx(url){
  const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const arrayBuffer=await res.arrayBuffer();
  const out=await window.mammoth.convertToHtml({arrayBuffer});
  lastType='docx'; docxHtmlOriginal = `<div class="docx-content">${out.value}</div>`; resultEl.innerHTML=docxHtmlOriginal;
}

function doSearch(){
  const query=qEl.value.trim(); const re=buildRegex(query); countsEl.textContent='';
  if(lastType==='srt'){
    let data=srtEntries;
    if(re && filterRowsEl.checked){ data = srtEntries.filter(e=> (new RegExp(re.source, re.flags)).test(e.text) || (new RegExp(re.source, re.flags)).test(e.start) || (new RegExp(re.source, re.flags)).test(e.end)); }
    renderSrt(data, re);
    if(re){ let hits=0; for(const e of data){ hits += countMatches(e.text,re); } countsEl.textContent=`å­—å¹•æ®µè½ï¼š${data.length} ï¼Œé«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}`; }
    else countsEl.textContent=`å­—å¹•æ®µè½ï¼š${data.length}`;
  }
  else if(lastType==='csv'){
    let rows=csvData.rows;
    if(re && filterRowsEl.checked){ rows = csvData.rows.filter(r=> r.some(c=> (new RegExp(re.source, re.flags)).test(String(c)))); }
    renderCsv(csvData.header, rows, re);
    if(re){ let hits=0; for(const r of rows){ for(const c of r){ hits += countMatches(c,re); } } countsEl.textContent=`åˆ—æ•¸ï¼š${rows.length} ï¼Œé«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}`; }
    else countsEl.textContent=`åˆ—æ•¸ï¼š${rows.length}`;
  }
  else if(lastType==='docx'){
    restoreDocx(); const root=resultEl.firstElementChild||resultEl; const hits = re? highlightInElement(root,re) : 0; countsEl.textContent = re? `é«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}` : '';
  }
}

// Wire events
loadBtn.addEventListener('click', loadFile);
qEl.addEventListener('input', doSearch);
searchBtn.addEventListener('click', doSearch);
clearBtn.addEventListener('click', ()=>{ qEl.value=''; doSearch(); });

// Init
loadTree('');
</script>
</body>
</html>
