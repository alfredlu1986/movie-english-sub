<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie English Sub / CSV / DOCX / PDF â€” Viewer + Search + Directory</title>
  <!-- DOCX -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <!-- === åªæ”¹ CSSï¼Œç¾åŒ–æ¨£å¼ï¼›JS èˆ‡ HTML çµæ§‹å®Œå…¨ä¸å‹• === -->
  <style>
    /* ===== é¢¨æ ¼ä¸»é¡Œï¼ˆä¿ç•™ä½ åŸæœ¬ class åç¨±ï¼‰ ===== */
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7f0;
      --brand:#2563eb;
      --brand2:#1d4ed8;
      --success:#16a34a;
      --danger:#b91c1c;
      --mark-bg:#fff2a8;
      --shadow:0 12px 32px rgba(15,23,42,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:16px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* å®¹å™¨èˆ‡å¡ç‰‡ */
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px}
    .card{
      background:var(--card);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:20px 22px;position:relative;overflow:hidden
    }
    .card::after{
      content:""; position:absolute; inset:auto -40% -60% -40%;
      height:210px; background:radial-gradient(1200px 120px at 50% 0%, rgba(37,99,235,.06), transparent 60%);
      pointer-events:none;
    }

    /* æ¨™é¡Œèˆ‡æ–‡å­— */
    h1{margin:0 0 8px;font-weight:800;letter-spacing:.2px;font-size:22px}
    h2{margin:0 0 10px;font-weight:700;font-size:16px}
    .sub{margin:0 0 14px;color:var(--muted)}
    code{background:#f1f5f9;padding:2px 6px;border-radius:8px}

    /* ç¶²æ ¼/æ¬„ä½ */
    .grid{display:grid;gap:12px}
    .layout{grid-template-columns: 340px 1fr}
    @media(max-width:1024px){ .layout{grid-template-columns:1fr} }

    label{display:block;font-weight:700;font-size:12px;color:#334155;margin:6px 0 6px;letter-spacing:.2px}
    input,select,button{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px;
      background:#fff; transition:border-color .15s, box-shadow .15s, transform .04s;
    }
    input:focus,select:focus{
      outline:none;border-color:#c7d2fe; box-shadow:0 0 0 3px #e0e7ff;
    }
    .tools{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .tools>*{flex:1}

    /* æŒ‰éˆ• */
    button{border:none;background:var(--brand);color:#fff;font-weight:800;cursor:pointer}
    button:hover{background:var(--brand2)}
    button:active{transform:translateY(1px)}
    #clearBtn{background:#334155}
    #clearBtn:hover{background:#1f2937}

    /* ç‹€æ…‹æç¤º */
    .status{margin-top:10px;font-size:13px;color:var(--muted)}
    .status .error{color:var(--danger);font-weight:800}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#64748b}

    /* çµæœå€èˆ‡è¡¨æ ¼ */
    .result{margin-top:14px;border-top:1px solid var(--line);padding-top:12px;overflow:auto;border-radius:12px}
    table{border-collapse:collapse;width:100%;font-size:14px;overflow:hidden;border-radius:10px}
    th,td{border:1px solid var(--line);padding:8px 10px;vertical-align:top}
    th{background:#f8fafc;font-weight:800}
    tbody tr:nth-child(odd){background:#fcfdff}
    tbody tr:hover{background:#f5f8ff}
    pre{white-space:pre-wrap;margin:0;background:#0f172a;color:#e5e7eb;padding:10px;border-radius:10px}
    mark{padding:0 3px;border-radius:4px;background:var(--mark-bg)}

    /* æ¨¹ç‹€ç›®éŒ„ */
    .tree{
      max-height:70vh;overflow:auto;border:1px solid var(--line);
      border-radius:12px;padding:8px;background:#fff
    }
    .tree ul{list-style:none;margin:0;padding-left:14px}
    .tree li{margin:2px 0}
    .node{display:flex;align-items:center;gap:8px}
    .toggle{
      border:none;background:transparent;cursor:pointer;font-size:14px;line-height:1;padding:2px 6px;border-radius:8px;
      color:#334155; transition:background .15s, transform .1s;
    }
    .toggle:hover{background:#eef2ff}
    .toggle:focus{outline:2px solid #e0e7ff}
    .fname{cursor:pointer;border-radius:8px;padding:2px 6px;transition:background .15s}
    .fname:hover{background:#f8fafc}
    .fname.file{color:#0ea5e9}
    .badge{
      font-size:11px;border:1px solid var(--line);border-radius:8px;padding:0 8px;color:#475569;margin-left:4px;
      background:#f8fafc
    }
    .hidden{display:none}

    /* PDF å€å¡Š */
    #pdfCanvasWrap{
      max-height:70vh;overflow:auto;border:1px solid var(--line);
      border-radius:12px;padding:8px;background:#fff
    }
    #pdfControls{align-items:center}
    #pdfControls .mini{flex:unset;width:auto}
    #pdfControls button{
      background:#0ea5e9;border:none
    }
    #pdfControls button:hover{background:#0284c7}
    #pdfPageInfo{margin-left:6px;color:#475569;font-weight:700}
    #pdfResults a{display:block;margin:2px 0;text-decoration:none;color:#334155}
    #pdfResults a:hover{color:#111827;text-decoration:underline}

    /* ç¯©é¸å€çš„æ ¸å–æ–¹å¡Š */
    .tools label{display:flex;gap:6px;align-items:center;border:1px solid var(--line);padding:8px 10px;border-radius:10px;background:#fff}
    .tools input[type="checkbox"]{width:auto}

    /* æ²è»¸å¾®å®¢è£½ï¼ˆæ”¯æ´ç€è¦½å™¨æœƒä½¿ç”¨ï¼‰ */
    .tree::-webkit-scrollbar,
    .result::-webkit-scrollbar,
    #pdfCanvasWrap::-webkit-scrollbar{width:10px;height:10px}
    .tree::-webkit-scrollbar-thumb,
    .result::-webkit-scrollbar-thumb,
    #pdfCanvasWrap::-webkit-scrollbar-thumb{background:#e5e7eb;border-radius:999px}
    .tree::-webkit-scrollbar-thumb:hover,
    .result::-webkit-scrollbar-thumb:hover,
    #pdfCanvasWrap::-webkit-scrollbar-thumb:hover{background:#cbd5e1}

    /* äº’å‹•ç´°ç¯€ */
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}
    input::placeholder{color:#94a3b8}
    .status code{padding:1px 6px;border-radius:6px;background:#f1f5f9}

    /* æ·±è‰²æ¨¡å¼ï¼ˆè·Ÿéš¨ç³»çµ±ï¼‰ */
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#1f2a44;
        --mark-bg:#584400; --shadow:0 12px 32px rgba(0,0,0,.35);
      }
      body{background:linear-gradient(180deg,#0b1220,#0e1424) fixed}
      .card{background:var(--card)}
      code{background:#0b1020}
      input,select{background:#0b1020;color:var(--ink);border-color:#243355}
      .tree{background:#0b1020;border-color:#243355}
      th{background:#0c1324}
      tbody tr:nth-child(odd){background:#0b1020}
      tbody tr:hover{background:#0c1427}
      #pdfCanvasWrap{background:#0b1020;border-color:#243355}
      .tools label{background:#0b1020;border-color:#243355;color:var(--ink)}
      .badge{background:#0c1324;border-color:#1f2a44;color:#cbd5e1}
      #clearBtn{background:#1f2937}
      #clearBtn:hover{background:#111827}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Movie English Sub / Words Viewer + PDF</h1>
      <p class="sub">æ”¯æ´ <b>.srt / .csv / .docx / .pdf</b> è®€å–ï¼‹é—œéµå­—æœå°‹ï¼ˆSRT/CSV å¯éæ¿¾åˆ—ï¼›DOCX å…¨æ–‡é«˜äº®ï¼›PDF åˆ—å‡ºå‘½ä¸­ä¸¦å¯è·³é ï¼‰ã€‚é è¨­ï¼š<code>alfredlu1986/movie-english-sub@main</code></p>

      <div class="grid" style="grid-template-columns:1.3fr 1fr 1fr">
        <div>
          <label>Owner</label>
          <input id="owner" value="alfredlu1986" />
        </div>
        <div>
          <label>Repo</label>
          <input id="repo" value="movie-english-sub" />
        </div>
        <div>
          <label>Branch</label>
          <input id="branch" value="main" />
        </div>
      </div>

      <div class="grid layout" style="margin-top:16px">
        <!-- left: tree -->
        <div class="card">
          <h2>ç›®éŒ„ / æª”æ¡ˆç€è¦½</h2>
          <div class="tools">
            <input id="treePath" placeholder="å¾æ­¤è·¯å¾‘è¼‰å…¥ï¼ˆç•™ç©º=æ ¹ç›®éŒ„ï¼Œä¾‹å¦‚ 1999/ï¼‰" />
            <button id="treeLoad">è¼‰å…¥ç›®éŒ„</button>
          </div>
          <div class="tools">
            <input id="nameFilter" placeholder="æª”åå³æ™‚éæ¿¾ï¼ˆä¸åˆ†å¤§å°å¯«ï¼‰" />
          </div>
          <div class="tools">
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showSRT" checked>.srt</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showCSV" checked>.csv</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showDOCX" checked>.docx</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showPDF" checked>.pdf</label>
            <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="showOTHER">å…¶ä»–</label>
          </div>
          <div id="treeStatus" class="status"></div>
          <div class="tree"><ul id="treeRoot"></ul></div>
        </div>

        <!-- right: viewer -->
        <div class="card">
          <h2>æª”æ¡ˆæª¢è¦– & æœå°‹</h2>
          <div class="grid" style="grid-template-columns:1fr 200px auto;gap:10px">
            <div>
              <label>æª”æ¡ˆè·¯å¾‘ï¼ˆç›¸å°æ–¼ repo rootï¼‰</label>
              <input id="path" placeholder="ä¾‹å¦‚ï¼šEnWords.csv / 1999/movie.srt / docs/sample.docx / docs/sample.pdf" />
            </div>
            <div>
              <label>æª”æ¡ˆé¡å‹</label>
              <select id="fileType">
                <option value="srt">SRT (.srt)</option>
                <option value="csv">CSV (.csv)</option>
                <option value="docx">DOCX (.docx)</option>
                <option value="pdf">PDF (.pdf)</option>
              </select>
            </div>
            <div style="align-self:end"><button id="loadBtn">è¼‰å…¥æª”æ¡ˆ</button></div>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr auto;gap:10px;margin-top:8px">
            <div>
              <label>é—œéµå­—æœå°‹</label>
              <input id="q" placeholder="è¼¸å…¥é—œéµå­—ï¼ŒEnter æˆ–æŒ‰ã€æœå°‹/é«˜äº®ã€" />
              <div class="status">SRT/CSV å¯ã€Œåªé¡¯ç¤ºç¬¦åˆã€ï¼›DOCX å…¨æ–‡é«˜äº®ï¼›PDF åˆ—å‡ºå‘½ä¸­ä¸¦å¯è·³é </div>
            </div>
            <div>
              <label>æœå°‹é¸é …</label>
              <div class="tools">
                <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="matchCase">å¤§å°å¯«ç›¸ç¬¦</label>
                <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="wholeWord">å…¨å­—æ¯”å°</label>
                <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" id="filterRows">åªé¡¯ç¤ºç¬¦åˆï¼ˆSRT/CSVï¼‰</label>
              </div>
            </div>
            <div style="align-self:end;display:flex;gap:8px">
              <button id="searchBtn">æœå°‹/é«˜äº®</button>
              <button id="clearBtn" style="background:#334155">æ¸…é™¤</button>
            </div>
          </div>

          <div id="status" class="status"></div>
          <div id="counts" class="status"></div>
          <div id="result" class="result"></div>
          <div id="pdfResults" class="status"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== PDF.js worker ====== */
if (window['pdfjsLib']) {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

/* ====== Helpers ====== */
const $ = id => document.getElementById(id);

const ownerEl = $("owner"), repoEl=$("repo"), branchEl=$("branch");
const pathEl=$("path"), typeEl=$("fileType"), loadBtn=$("loadBtn");
const qEl=$("q"), matchCaseEl=$("matchCase"), wholeWordEl=$("wholeWord"), filterRowsEl=$("filterRows");
const searchBtn=$("searchBtn"), clearBtn=$("clearBtn");
const statusEl=$("status"), countsEl=$("counts"), resultEl=$("result"), pdfResultsEl=$("pdfResults");

const treeRoot=$("treeRoot"), treeStatus=$("treeStatus"), treeLoad=$("treeLoad"), treePathEl=$("treePath");
const showSRT=$("showSRT"), showCSV=$("showCSV"), showDOCX=$("showDOCX"), showPDF=$("showPDF"), showOTHER=$("showOTHER"), nameFilter=$("nameFilter");

function rawBase(){
  const o=ownerEl.value.trim()||"alfredlu1986";
  const r=repoEl.value.trim()||"movie-english-sub";
  const b=branchEl.value.trim()||"main";
  return {o,r,b,url:`https://raw.githubusercontent.com/${o}/${r}/${b}/`};
}
function apiBase(){
  const o=ownerEl.value.trim()||"alfredlu1986";
  const r=repoEl.value.trim()||"movie-english-sub";
  const b=branchEl.value.trim()||"main";
  // æ³¨æ„ï¼šä¸è¦çµå°¾æ–œç·šï¼Œroot éœ€æ‰“åˆ° .../contents
  return {o,r,b,url:`https://api.github.com/repos/${o}/${r}/contents`, ref:b};
}
function escapeHtml(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");}
function buildRegex(query){
  if(!query) return null;
  const src = wholeWordEl.checked ? `\\b${escapeRegExp(query)}\\b` : escapeRegExp(query);
  return new RegExp(src, matchCaseEl.checked ? "g" : "gi");
}
function cloneRe(re){ return new RegExp(re.source, re.flags); }
function countMatches(str, re){
  if(!re) return 0; const r = cloneRe(re);
  const m = String(str).match(r); return m? m.length: 0;
}
function extOf(name){ const m=(name||"").toLowerCase().match(/\.([a-z0-9]+)$/); return m?m[1]:""; }
function showByExt(name){
  const e=extOf(name);
  if(e==='srt') return showSRT.checked;
  if(e==='csv') return showCSV.checked;
  if(e==='docx') return showDOCX.checked;
  if(e==='pdf') return showPDF.checked;
  return showOTHER.checked;
}

/* ====== Directory Tree ====== */
async function fetchDir(path){
  const {url, ref} = apiBase();
  const base = url; // no trailing slash
  const target = (path && path.length) ? `${base}/${encodeURIComponent(path).replace(/%2F/g,'/')}` : base;
  const api = `${target}?ref=${encodeURIComponent(ref)}`;
  const res = await fetch(api);
  if(!res.ok) throw new Error(`GitHub API ${res.status}`);
  const data = await res.json();
  if(!Array.isArray(data)) throw new Error('éç›®éŒ„æˆ–è·¯å¾‘ä¸å­˜åœ¨');
  data.sort((a,b)=> (a.type===b.type? a.name.localeCompare(b.name) : (a.type==='dir'?-1:1)) );
  return data;
}
function renderClosedFolder(fullPath){
  const li=document.createElement('li'); li.className='node dir';
  const head=document.createElement('div'); head.className='node';
  const btn=document.createElement('button'); btn.className='toggle'; btn.textContent='â–¸';
  const span=document.createElement('span'); span.className='fname'; span.textContent='ğŸ“ '+fullPath.split('/').pop();
  head.appendChild(btn); head.appendChild(span); li.appendChild(head);
  const ul=document.createElement('ul'); ul.className='hidden'; li.appendChild(ul);
  let loaded=false, collapsed=true;
  async function expand(){
    if(!loaded){
      try{
        const kids = await fetchDir(fullPath);
        for(const ent of kids){ (ent.type==='dir') ? ul.appendChild(renderClosedFolder(ent.path)) : ul.appendChild(renderFile(ent.path, ent.name)); }
        loaded = true; applyTreeFilters();
      }catch(e){
        const errLi = document.createElement('li');
        errLi.innerHTML = `<span class="status">ç„¡æ³•è®€å–ï¼š${escapeHtml(e.message||String(e))}</span>`;
        ul.appendChild(errLi);
      }
    }
    collapsed=false; btn.textContent='â–¾'; ul.classList.remove('hidden');
  }
  function collapse(){ collapsed=true; btn.textContent='â–¸'; ul.classList.add('hidden'); }
  btn.addEventListener('click', ()=> collapsed?expand():collapse());
  span.addEventListener('click', ()=> collapsed?expand():collapse());
  return li;
}
function renderFile(fullPath, name){
  const li=document.createElement('li'); li.className='node file'; li.dataset.fullPath=fullPath;
  const row=document.createElement('div'); row.className='node';
  const a=document.createElement('a'); a.href='#'; a.className='fname file'; a.textContent='ğŸ“„ '+name; a.title=fullPath;
  const badge=document.createElement('span'); badge.className='badge'; badge.textContent=extOf(name)||'file';
  row.appendChild(a); row.appendChild(badge); li.appendChild(row);
  a.addEventListener('click', e=>{ e.preventDefault(); openFileFromTree(fullPath,name); });
  return li;
}
function renderDirNode(path, entries){
  const li=document.createElement('li'); li.className='node dir';
  const header=document.createElement('div'); header.className='node';
  const btn=document.createElement('button'); btn.className='toggle'; btn.textContent='â–¾';
  const span=document.createElement('span'); span.className='fname'; span.textContent='ğŸ“ '+(path||'/');
  header.appendChild(btn); header.appendChild(span); li.appendChild(header);
  const ul=document.createElement('ul'); li.appendChild(ul);
  for(const ent of entries){ (ent.type==='dir') ? ul.appendChild(renderClosedFolder(ent.path)) : ul.appendChild(renderFile(ent.path, ent.name)); }
  let collapsed=false; btn.addEventListener('click',()=>{collapsed=!collapsed; btn.textContent=collapsed?'â–¸':'â–¾'; ul.classList.toggle('hidden',collapsed)});
  return li;
}
async function loadTree(path){
  treeStatus.textContent='è®€å–ä¸­â€¦'; treeRoot.innerHTML='';
  try{
    const root=await fetchDir(path||'');
    treeRoot.appendChild(renderDirNode(path||'/', root));
    treeStatus.textContent='å®Œæˆã€‚é»è³‡æ–™å¤¾å±•é–‹/æ”¶åˆï¼Œé»æª”æ¡ˆå³è¼‰å…¥ã€‚';
    applyTreeFilters();
  }catch(e){
    treeStatus.innerHTML=`<span class="error">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(e.message||String(e))}</span>`;
  }
}
function applyTreeFilters(){
  const q=(nameFilter.value||'').toLowerCase();
  const items=treeRoot.querySelectorAll('li.node.file');
  items.forEach(li=>{
    const name=li.querySelector('.fname').textContent.toLowerCase();
    const okExt=showByExt(name); const okName=!q || name.includes(q);
    li.style.display=(okExt && okName) ? '' : 'none';
  });
}
function openFileFromTree(fullPath,name){
  pathEl.value=fullPath;
  const e=extOf(name);
  typeEl.value = (e==='srt'||e==='csv'||e==='docx'||e==='pdf') ? e : 'srt';
  loadFile();
}
treeLoad.addEventListener('click',()=>loadTree(treePathEl.value.trim()));
ownerEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
repoEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
branchEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
nameFilter.addEventListener('input', applyTreeFilters);
[showSRT,showCSV,showDOCX,showPDF,showOTHER].forEach(el=> el.addEventListener('change', applyTreeFilters));

/* ====== File renderers ====== */
let lastType=null; let srtEntries=[]; let csvData={header:[],rows:[]}; let docxHtmlOriginal='';
let pdfState = { doc:null, page:1, pages:0, scale:1.25, pageTexts:[] };

function highlightText(text, re){
  if(!re || text==null) return escapeHtml(text);
  const s=String(text); let out=''; let last=0; const r=cloneRe(re);
  let m; while((m=r.exec(s))){
    out += escapeHtml(s.slice(last, m.index));
    out += `<mark>${escapeHtml(m[0])}</mark>`;
    last = m.index + m[0].length;
    if(!r.global) break;
  }
  out += escapeHtml(s.slice(last));
  return out;
}

/* SRT */
function parseSrt(text){
  const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const blocks = norm.split(/\n{2,}/);
  const entries=[];
  for(const b of blocks){
    const lines=b.trim().split('\n'); if(!lines[0]) continue;
    let idx=lines[0].trim(), timeLine='', textLines=[];
    if(/^\d+$/.test(idx) && lines.length>=2){ timeLine=lines[1].trim(); textLines=lines.slice(2); }
    else { idx=''; timeLine=lines[0].trim(); textLines=lines.slice(1); }
    let start='', end=''; const m=timeLine.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/); if(m){ start=m[1]; end=m[2]; }
    entries.push({index:idx,start,end,text:textLines.join('\n')});
  }
  return entries;
}
function renderSrt(entries, re){
  let html = '<table><thead><tr><th>#</th><th>Start</th><th>End</th><th>Text</th></tr></thead><tbody>';
  for(const e of entries){
    html += `<tr><td>${escapeHtml(e.index||'')}</td><td>${escapeHtml(e.start)}</td><td>${escapeHtml(e.end)}</td><td><pre>${re?highlightText(e.text,re):escapeHtml(e.text)}</pre></td></tr>`;
  }
  html += '</tbody></table>'; resultEl.innerHTML=html;
}

/* CSV */
function parseCsv(text){
  const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  let lines = norm.split('\n');
  while(lines.length && lines[lines.length-1].trim()==='') lines.pop();
  if(lines.length && lines[0].charCodeAt(0)===65279) lines[0]=lines[0].slice(1); // UTF-8 BOM
  if(!lines.length) return {header:[],rows:[]};
  const header = splitCsvLine(lines[0]);
  const rows = lines.slice(1).map(splitCsvLine);
  return {header, rows};
}
function splitCsvLine(line){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(inQ){
      if(ch==='"'){ if(i+1<line.length && line[i+1]=='"'){ cur+='"'; i++; } else inQ=false; }
      else cur+=ch;
    }else{
      if(ch==='"') inQ=true;
      else if(ch===','){ out.push(cur); cur=''; }
      else cur+=ch;
    }
  }
  out.push(cur); return out;
}
function renderCsv(header, rows, re){
  let html = '<table><thead><tr>'+header.map(h=>`<th>${escapeHtml(h)}</th>`).join('')+'</tr></thead><tbody>';
  for(const row of rows){
    html += '<tr>' + header.map((_,i)=>{ const cell=row[i]??''; return `<td>${re?highlightText(cell,re):escapeHtml(cell)}</td>`; }).join('') + '</tr>';
  }
  html += '</tbody></table>'; resultEl.innerHTML=html;
}

/* DOCX */
function restoreDocx(){ resultEl.innerHTML = docxHtmlOriginal; }

/* PDF */
function renderPdfUI(){
  resultEl.innerHTML = `
    <div class="tools" id="pdfControls">
      <button id="pdfPrev" class="mini">ä¸Šä¸€é </button>
      <button id="pdfNext" class="mini">ä¸‹ä¸€é </button>
      <button id="pdfZoomOut" class="mini">ç¸®å°</button>
      <button id="pdfZoomIn" class="mini">æ”¾å¤§</button>
      <span id="pdfPageInfo" class="mini"></span>
    </div>
    <div id="pdfCanvasWrap"><canvas id="pdfCanvas"></canvas></div>
  `;
  // bind
  $("pdfPrev").onclick = ()=>{ if(pdfState.page>1){ pdfState.page--; renderPdfPage(); } };
  $("pdfNext").onclick = ()=>{ if(pdfState.page<pdfState.pages){ pdfState.page++; renderPdfPage(); } };
  $("pdfZoomOut").onclick = ()=>{ pdfState.scale = Math.max(0.5, pdfState.scale-0.25); renderPdfPage(); };
  $("pdfZoomIn").onclick = ()=>{ pdfState.scale = Math.min(3, pdfState.scale+0.25); renderPdfPage(); };
}
async function renderPdfPage(){
  const page = await pdfState.doc.getPage(pdfState.page);
  const viewport = page.getViewport({scale: pdfState.scale});
  const canvas = $("pdfCanvas"); const ctx = canvas.getContext('2d');
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({canvasContext: ctx, viewport}).promise;
  $("pdfPageInfo").textContent = `é  ${pdfState.page} / ${pdfState.pages}ï¼ˆç¸®æ”¾ ${pdfState.scale.toFixed(2)}xï¼‰`;
}
async function extractPdfTexts(){
  // æå–æ¯é æ–‡å­—ï¼ˆä¾›æœå°‹ï¼‰
  pdfState.pageTexts = new Array(pdfState.pages+1).fill("");
  for(let p=1; p<=pdfState.pages; p++){
    const page = await pdfState.doc.getPage(p);
    const tc = await page.getTextContent();
    pdfState.pageTexts[p] = tc.items.map(i=>i.str).join(" ");
  }
}

/* ====== Load & Search dispatcher ====== */
loadBtn.addEventListener('click', loadFile);
qEl.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
searchBtn.addEventListener('click', doSearch);
clearBtn.addEventListener('click', ()=>{ qEl.value=''; doSearch(); });

async function loadFile(){
  const rel=(pathEl.value||'').trim();
  if(!rel){ statusEl.innerHTML='<span class="error">è«‹è¼¸å…¥æª”æ¡ˆè·¯å¾‘ã€‚</span>'; return; }
  const base=rawBase(); const full=encodeURI(base.url + rel);
  let type=typeEl.value; const lower=rel.toLowerCase();
  if(lower.endsWith('.srt')) type='srt';
  else if(lower.endsWith('.csv')) type='csv';
  else if(lower.endsWith('.docx')) type='docx';
  else if(lower.endsWith('.pdf')) type='pdf';
  typeEl.value = type;

  statusEl.textContent=`è¼‰å…¥ä¸­ï¼š${full}`; countsEl.textContent=''; resultEl.innerHTML=''; pdfResultsEl.innerHTML='';
  try{
    if(type==='docx'){
      await loadDocx(full);
    }else if(type==='pdf'){
      await loadPdf(full);
    }else{
      await loadTextFile(full, type);
    }
    const ghUrl=`https://github.com/${base.o}/${base.r}/blob/${base.b}/${rel}`;
    statusEl.innerHTML=`è¼‰å…¥å®Œæˆï¼š<a href="${full}" target="_blank" rel="noopener">Raw</a> Â· <a href="${ghUrl}" target="_blank" rel="noopener">GitHub</a>`;
    doSearch(); // åˆæ¬¡æ¸²æŸ“å¾Œåšä¸€æ¬¡æœå°‹/é«˜äº®
  }catch(e){
    statusEl.innerHTML=`<span class="error">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(e.message||String(e))}</span>`;
  }
}

async function loadTextFile(url, type){
  const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const text=await res.text();
  if(type==='srt'){ lastType='srt'; srtEntries=parseSrt(text); renderSrt(srtEntries); }
  else if(type==='csv'){ lastType='csv'; csvData=parseCsv(text); renderCsv(csvData.header, csvData.rows); }
}
async function loadDocx(url){
  const res=await fetch(url); if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const arrayBuffer=await res.arrayBuffer();
  const out=await window.mammoth.convertToHtml({arrayBuffer});
  lastType='docx'; docxHtmlOriginal = `<div class="docx-content">${out.value}</div>`; resultEl.innerHTML=docxHtmlOriginal;
}
async function loadPdf(url){
  const doc = await pdfjsLib.getDocument({ url }).promise;
  pdfState.doc = doc; pdfState.pages = doc.numPages; pdfState.page = 1; pdfState.scale = 1.25;
  lastType='pdf'; renderPdfUI(); await renderPdfPage(); await extractPdfTexts();
}

/* ====== Search ====== */
function doSearch(){
  const q=qEl.value.trim(); const re=buildRegex(q); countsEl.textContent=''; pdfResultsEl.innerHTML='';
  if(lastType==='srt'){
    let data=srtEntries;
    if(re && filterRowsEl.checked){
      data = srtEntries.filter(e=>{
        const r=cloneRe(re);
        return r.test(e.text)||r.test(e.start)||r.test(e.end);
      });
    }
    renderSrt(data, re);
    countsEl.textContent = re ? `å­—å¹•æ®µè½ï¼š${data.length} ï¼Œé«˜äº®æ¬¡æ•¸ï¼šç´„ ${data.reduce((a,e)=>a+countMatches(e.text,re),0)}` : `å­—å¹•æ®µè½ï¼š${data.length}`;
  }
  else if(lastType==='csv'){
    let rows=csvData.rows;
    if(re && filterRowsEl.checked){
      rows = csvData.rows.filter(r=> r.some(c=> cloneRe(re).test(String(c))));
    }
    renderCsv(csvData.header, rows, re);
    if(re){
      let hits=0; for(const r of rows){ for(const c of r){ hits += countMatches(c,re); } }
      countsEl.textContent=`åˆ—æ•¸ï¼š${rows.length} ï¼Œé«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}`;
    }else countsEl.textContent=`åˆ—æ•¸ï¼š${rows.length}`;
  }
  else if(lastType==='docx'){
    restoreDocx();
    const root = resultEl.firstElementChild || resultEl;
    const hits = re ? highlightInElement(root,re) : 0;
    countsEl.textContent = re ? `é«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}` : '';
  }
  else if(lastType==='pdf'){
    if(!re || !pdfState.pageTexts.length){ countsEl.textContent=''; pdfResultsEl.innerHTML=''; return; }
    // æœå°‹å„é 
    let total=0; const items=[];
    for(let p=1; p<=pdfState.pages; p++){
      const text = pdfState.pageTexts[p] || "";
      const r = cloneRe(re); let m; let idxs=[];
      while((m=r.exec(text))){ idxs.push({i:m.index, len:m[0].length}); if(!r.global) break; }
      total += idxs.length;
      for(const it of idxs){
        const start = Math.max(0, it.i-30), end = Math.min(text.length, it.i+it.len+30);
        const pre=text.slice(start, it.i), mid=text.slice(it.i, it.i+it.len), post=text.slice(it.i+it.len, end);
        const snippet = `${escapeHtml(pre)}<mark>${escapeHtml(mid)}</mark>${escapeHtml(post)}`;
        items.push({p, snippet});
      }
    }
    countsEl.textContent = `PDF å‘½ä¸­æ¬¡æ•¸ï¼šç´„ ${total}ï¼ˆ${pdfState.pages} é ï¼‰`;
    if(items.length){
      const html = items.slice(0,300).map((it,idx)=>`<a href="#" data-page="${it.p}">ç¬¬ ${it.p} é ï¼šâ€¦ ${it.snippet} â€¦</a>`).join("");
      pdfResultsEl.innerHTML = html;
      pdfResultsEl.querySelectorAll('a').forEach(a=>{
        a.addEventListener('click', (e)=>{
          e.preventDefault();
          const p = Number(a.dataset.page)||1; pdfState.page=p; renderPdfPage();
        });
      });
    }else{
      pdfResultsEl.textContent = 'ï¼ˆæ²’æœ‰æ‰¾åˆ°é—œéµå­—ï¼‰';
    }
  }
}

/* DOCX highlighter */
function highlightInElement(root, re){
  if(!re) return 0; let cnt=0;
  const walker=document.createTreeWalker(root, NodeFilter.SHOW_TEXT); const nodes=[];
  while(walker.nextNode()) nodes.push(walker.currentNode);
  for(const node of nodes){
    const s=node.nodeValue; const r=cloneRe(re); if(!r.test(s)) continue; r.lastIndex=0;
    const frag=document.createDocumentFragment(); let last=0; let m;
    while((m=r.exec(s))){
      if(m.index>last) frag.appendChild(document.createTextNode(s.slice(last, m.index)));
      const mark=document.createElement('mark'); mark.textContent=m[0]; frag.appendChild(mark);
      last = m.index + m[0].length; cnt++; if(!r.global) break;
    }
    if(last<s.length) frag.appendChild(document.createTextNode(s.slice(last)));
    node.parentNode.replaceChild(frag, node);
  }
  return cnt;
}

/* init */
loadTree('');
</script>
</body>
</html>
