<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Movie English Sub â€” Viewer + Search + Directory (Aesthetic)</title>
<!-- DOCX -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  :root{
    --bg1:#ff6a3d; --bg2:#f6b756;
    --surface:#ffffff; --ink:#0f172a; --muted:#6b7280;
    --primary:#2563eb; --primary-2:#1d4ed8; --line:#e5e7eb;
    --radius:14px; --shadow:0 10px 30px rgba(15,23,42,.08);
  }
  *{box-sizing:border-box}
  body{
    margin:0;color:var(--ink);
    font:15px/1.6 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
    background:linear-gradient(135deg,var(--bg1),var(--bg2)) fixed;
  }
  .wrap{max-width:1180px;margin:28px auto;padding:0 16px}
  .chrome{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .grid{display:grid;grid-template-columns:56px 1fr 320px;gap:16px}
  @media(max-width:1100px){.grid{grid-template-columns:56px 1fr}}
  /* å·¦å´åœ–ç¤ºæ¬„ */
  .sidebar{background:#f9fafb;border:1px solid var(--line);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;align-items:center}
  .iconbtn{width:36px;height:36px;border-radius:10px;border:1px solid var(--line);display:grid;place-items:center;background:#fff;cursor:pointer;transition:transform .08s, box-shadow .15s, border-color .15s}
  .iconbtn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.08)}
  .iconbtn.active{border-color:#c7d2fe;box-shadow:0 0 0 3px #e0e7ff}
  .iconbtn svg{width:18px;height:18px;opacity:.9}
  /* ä¸­æ¬„ï¼šé é¦– + ä¸‹æ–¹å…©æ¬„ï¼ˆç›®éŒ„/æª¢è¦–å™¨ï¼‰ */
  .content{display:grid;gap:16px}
  .header{
    border:1px solid var(--line);border-radius:12px;padding:14px 16px;background:#fff;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between
  }
  .brand{font-weight:800;letter-spacing:.2px}
  .controls{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:10px;min-width:320px}
  label{display:block;font-weight:600;font-size:12px;margin-bottom:3px;color:#374151}
  input,select,button{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:14px}
  select{background:#fff}
  button{border:none;background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
  button:hover{background:var(--primary-2)}
  .twocol{display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media(max-width:900px){.twocol{grid-template-columns:1fr}}
  /* ç›®éŒ„å¡ */
  .panel{border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;display:grid;gap:10px}
  .tree{max-height:68vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:8px}
  .tree ul{list-style:none;margin:0;padding-left:14px}
  .tree li{margin:2px 0}
  .node{display:flex;align-items:center;gap:6px}
  .toggle{border:none;background:transparent;cursor:pointer;font-size:14px;line-height:1;padding:2px 4px}
  .fname{cursor:pointer}
  .fname.file{color:#0ea5e9}
  .badge{font-size:10px;border:1px solid var(--line);border-radius:6px;padding:0 6px;color:#475569}
  .hidden{display:none}
  /* æª¢è¦–å™¨å¡ */
  .result{margin-top:8px;border-top:1px solid var(--line);padding-top:12px;overflow:auto;background:#fff;border-radius:12px}
  .hint{font-size:12px;color:var(--muted)}
  table{border-collapse:collapse;width:100%;font-size:14px}
  th,td{border:1px solid var(--line);padding:6px 8px;vertical-align:top}
  th{background:#f1f5f9}
  pre{white-space:pre-wrap;background:#0f172a;color:#e5e7eb;padding:8px;border-radius:8px;margin:0}
  mark{padding:0 2px;border-radius:3px}
  /* PDF viewer */
  #pdfCanvasWrap{max-height:68vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:8px;background:#fff}
  #pdfResults a{display:block;margin:2px 0}
  /* å³æ¬„æ¨è–¦ */
  .right .panel .card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;display:grid;grid-template-columns:64px 1fr;gap:10px}
  .imgph{width:64px;height:64px;border-radius:10px;background:#ffe9d6}
  .link{color:var(--primary);text-decoration:none;font-weight:700}
  .link:hover{text-decoration:underline}
  .status{font-size:13px;color:var(--muted)}
  .status .error{color:#b91c1c;font-weight:700}
</style>
</head>
<body>
  <div class="wrap">
    <div class="chrome grid">
      <!-- å·¦ï¼šåœ–ç¤ºå´æ¬„ -->
      <aside class="sidebar">
        <div class="iconbtn active" title="Viewer">
          <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="8" r="4" stroke="#111827" stroke-width="1.5"/><path d="M4 20c1.6-3.5 5-5.5 8-5.5s6.4 2 8 5.5" stroke="#111827" stroke-width="1.5" stroke-linecap="round"/></svg>
        </div>
        <div class="iconbtn" title="Docs"><svg viewBox="0 0 24 24" fill="none"><rect x="4" y="4" width="7" height="7" rx="2" stroke="#111827" stroke-width="1.5"/><rect x="13" y="4" width="7" height="7" rx="2" stroke="#111827" stroke-width="1.5"/><rect x="4" y="13" width="7" height="7" rx="2" stroke="#111827" stroke-width="1.5"/><rect x="13" y="13" width="7" height="7" rx="2" stroke="#111827" stroke-width="1.5"/></svg></div>
        <div class="iconbtn" title="Search"><svg viewBox="0 0 24 24" fill="none"><circle cx="11" cy="11" r="7" stroke="#111827" stroke-width="1.5"/><path d="M20 20l-3-3" stroke="#111827" stroke-width="1.5" stroke-linecap="round"/></svg></div>
      </aside>

      <!-- ä¸­ï¼šå…§å®¹ -->
      <main class="content">
        <!-- é é¦–æ§åˆ¶åˆ— -->
        <section class="header">
          <div class="brand">Movie English Sub â€” Files</div>
          <div class="controls">
            <div>
              <label>Owner</label>
              <input id="owner" value="alfredlu1986" />
            </div>
            <div>
              <label>Repo</label>
              <input id="repo" value="movie-english-sub" />
            </div>
            <div>
              <label>Branch</label>
              <input id="branch" value="main" />
            </div>
            <div style="align-self:end">
              <button id="reloadTree">Reload Tree</button>
            </div>
          </div>
        </section>

        <!-- ç›®éŒ„ & æª¢è¦–å™¨ -->
        <section class="twocol">
          <!-- å·¦ï¼šç›®éŒ„ -->
          <div class="panel">
            <div style="display:grid;gap:10px">
              <div>
                <label>å¾æ­¤è·¯å¾‘è¼‰å…¥ï¼ˆç•™ç©º=æ ¹ç›®éŒ„ï¼‰</label>
                <input id="treePath" placeholder="ä¾‹å¦‚ 1999/" />
              </div>
              <div>
                <label>æª”åå³æ™‚éæ¿¾</label>
                <input id="nameFilter" placeholder="ä¸åˆ†å¤§å°å¯«" />
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <label><input type="checkbox" id="showSRT" checked> .srt</label>
                <label><input type="checkbox" id="showCSV" checked> .csv</label>
                <label><input type="checkbox" id="showDOCX" checked> .docx</label>
                <label><input type="checkbox" id="showPDF" checked> .pdf</label>
                <label><input type="checkbox" id="showOTHER" checked> å…¶ä»–</label>
              </div>
              <div class="status" id="treeStatus"></div>
            </div>
            <div class="tree"><ul id="treeRoot"></ul></div>
          </div>

          <!-- å³ï¼šæª¢è¦–å™¨ -->
          <div class="panel">
            <div class="grid" style="grid-template-columns:1fr 200px auto;gap:10px">
              <div>
                <label>æª”æ¡ˆè·¯å¾‘ï¼ˆç›¸å°æ–¼ repo rootï¼‰</label>
                <input id="path" placeholder="EnWords.csv / 1999/movie.srt / docs/sample.docx / docs/sample.pdf" />
              </div>
              <div>
                <label>æª”æ¡ˆé¡å‹</label>
                <select id="fileType">
                  <option value="srt">SRT</option>
                  <option value="csv">CSV</option>
                  <option value="docx">DOCX</option>
                  <option value="pdf">PDF</option>
                </select>
              </div>
              <div style="align-self:end">
                <button id="loadBtn">è¼‰å…¥æª”æ¡ˆ</button>
              </div>
            </div>

            <div class="grid" style="grid-template-columns:1fr 1fr auto;gap:10px;margin-top:8px">
              <div>
                <label>é—œéµå­—æœå°‹</label>
                <input id="q" placeholder="è¼¸å…¥é—œéµå­—ï¼ŒEnter æˆ–æŒ‰ã€æœå°‹/é«˜äº®ã€" />
                <div class="hint">SRT/CSV å¯ã€Œåªé¡¯ç¤ºç¬¦åˆã€ï¼›DOCX å…¨æ–‡é«˜äº®ï¼›PDF åˆ—å‡ºå‘½ä¸­ç‰‡æ®µä¸¦å¯è·³é </div>
              </div>
              <div>
                <label>æœå°‹é¸é …</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <label><input type="checkbox" id="matchCase"> å¤§å°å¯«ç›¸ç¬¦</label>
                  <label><input type="checkbox" id="wholeWord"> å…¨å­—æ¯”å°</label>
                  <label><input type="checkbox" id="filterRows"> åªé¡¯ç¤ºç¬¦åˆï¼ˆSRT/CSVï¼‰</label>
                </div>
              </div>
              <div style="align-self:end;display:flex;gap:8px">
                <button id="searchBtn">æœå°‹/é«˜äº®</button>
                <button id="clearBtn" style="background:#334155">æ¸…é™¤</button>
              </div>
            </div>

            <div class="status" id="status"></div>
            <div class="status" id="counts"></div>
            <div class="result" id="result"></div>
            <div class="status" id="pdfResults"></div>
          </div>
        </section>
      </main>

      <!-- å³ï¼šæ¨è–¦/æœ€è¿‘ -->
      <aside class="right">
        <div class="panel">
          <h4>Recently Viewed</h4>
          <div class="card">
            <div class="imgph"></div>
            <div>
              <b>Leather Tote</b><br/>
              <a class="link" href="#">See your browsing history</a>
            </div>
          </div>
        </div>
        <div class="panel">
          <h4>Suggestions for You</h4>
          <div class="card">
            <div class="imgph" style="background:#d4f1f4"></div>
            <div>
              <b>Travel Backpack</b><br/>
              <a class="link" href="#">Watch more</a>
            </div>
          </div>
          <div class="card">
            <div class="imgph" style="background:#e0e7ff"></div>
            <div>
              <b>Smart Watch</b><br/>
              <a class="link" href="#">Explore deals</a>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ===== PDF.js worker ===== */
if (window['pdfjsLib']) {
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);

const ownerEl = $("owner"), repoEl=$("repo"), branchEl=$("branch");
const reloadTreeBtn = $("reloadTree");
const pathEl=$("path"), typeEl=$("fileType"), loadBtn=$("loadBtn");
const qEl=$("q"), matchCaseEl=$("matchCase"), wholeWordEl=$("wholeWord"), filterRowsEl=$("filterRows");
const searchBtn=$("searchBtn"), clearBtn=$("clearBtn");
const statusEl=$("status"), countsEl=$("counts"), resultEl=$("result"), pdfResultsEl=$("pdfResults");

const treeRoot=$("treeRoot"), treeStatus=$("treeStatus"), treePathEl=$("treePath");
const showSRT=$("showSRT"), showCSV=$("showCSV"), showDOCX=$("showDOCX"), showPDF=$("showPDF"), showOTHER=$("showOTHER"), nameFilter=$("nameFilter");

function rawBase(){
  const o=ownerEl.value.trim()||"alfredlu1986";
  const r=repoEl.value.trim()||"movie-english-sub";
  const b=branchEl.value.trim()||"main";
  return {o,r,b,url:`https://raw.githubusercontent.com/${o}/${r}/${b}/`};
}
function apiBase(){
  const o = ownerEl.value.trim() || "alfredlu1986";
  const r = repoEl.value.trim() || "movie-english-sub";
  const b = branchEl.value.trim() || "main";
  // ä¸èƒ½æœ‰å°¾æ–œç·šï¼š/contentsï¼ˆè€Œä¸æ˜¯ /contents/ï¼‰
  return { o, r, b, url: `https://api.github.com/repos/${o}/${r}/contents`, ref: b };
}
function normalizePath(p){
  if(!p) return "";
  // å»ç©ºç™½ã€å»æ‰å‰å° "/"ï¼Œæœ«ç«¯çš„ "/" ä¹Ÿæ‹¿æ‰ï¼ˆGitHub API å° "/" è¦–ç‚ºéæ³•è·¯å¾‘ï¼‰
  p = String(p).trim().replace(/^\/+/, "").replace(/\/+$/, "");
  return p;
}

function escapeHtml(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;");}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&");}
function buildRegex(query){
  if(!query) return null;
  const src = wholeWordEl.checked ? `\\\\b${escapeRegExp(query)}\\\\b` : escapeRegExp(query);
  return new RegExp(src, matchCaseEl.checked ? "g" : "gi");
}
function cloneRe(re){ return new RegExp(re.source, re.flags); }
function countMatches(str, re){ if(!re) return 0; const r=cloneRe(re); const m=String(str).match(r); return m?m.length:0; }
function extOf(name){ const m=(name||"").toLowerCase().match(/\\.([a-z0-9]+)$/); return m?m[1]:""; }
function showByExt(name){
  const e=extOf(name);
  if(e==='srt') return showSRT.checked;
  if(e==='csv') return showCSV.checked;
  if(e==='docx') return showDOCX.checked;
  if(e==='pdf') return showPDF.checked;
  return showOTHER.checked;
}

/* ===== Directory Tree ===== */
async function loadTree(path=""){
  const clean = normalizePath(path);
  treeStatus.textContent = 'è®€å–ä¸­â€¦';
  treeRoot.innerHTML = '';
  try{
    const root = await fetchDir(clean);
    const rootNode = renderDirNode(clean || '', root);
    treeRoot.appendChild(rootNode);
    treeStatus.textContent = 'å®Œæˆã€‚é»è³‡æ–™å¤¾å±•é–‹/æ”¶åˆï¼Œé»æª”æ¡ˆå³è¼‰å…¥ã€‚';
    applyTreeFilters();
  }catch(err){
    treeStatus.innerHTML = `<span class="error">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(err.message||String(err))}</span>`;
  }
}

async function fetchDir(path){
  const { url, ref } = apiBase();           // url = .../contentsï¼ˆæ³¨æ„ï¼šç„¡å°¾æ–œç·šï¼‰
  const clean = normalizePath(path);
  const target = clean ? `${url}/${encodeURIComponent(clean).replace(/%2F/g,'/')}` : url;
  const api = `${target}?ref=${encodeURIComponent(ref)}`;
  const res = await fetch(api);
  if(!res.ok) throw new Error(`GitHub API ${res.status}`);
  const data = await res.json();
  if(!Array.isArray(data)) throw new Error('éç›®éŒ„ï¼ˆæˆ–è·¯å¾‘ä¸å­˜åœ¨ï¼‰');
  data.sort((a,b)=> (a.type===b.type? a.name.localeCompare(b.name) : (a.type==='dir'?-1:1)) );
  return data;
}

// ===== ç›®éŒ„æ¨¹é»æ“Šå§”æ´¾ï¼ˆé¿å…å› æ¨£å¼èª¿æ•´é€ æˆ listener éºå¤±ï¼‰ =====
// ä¸€æ¬¡æ›å¥½ï¼Œé¿å… UI ç¾åŒ–æ”¹çµæ§‹å¾Œ listener è·‘æ‰
treeRoot.addEventListener('click', async (e)=>{
  // é»æª”æ¡ˆï¼šç›´æ¥è¼‰å…¥
  const fileA = e.target.closest('.fname.file');
  if(fileA){
    e.preventDefault();
    const li = fileA.closest('li.node.file');
    const fullPath = li?.dataset?.fullPath || fileA.title;
    if(fullPath) openFileFromTree(fullPath, fileA.textContent.replace(/^ğŸ“„\s*/,''));
    return;
  }

  // é»è³‡æ–™å¤¾ï¼ˆæŒ‰éˆ•æˆ–æ•´åˆ—ï¼‰
  const liDir = e.target.closest('li.dir');
  if(!liDir) return;

  const btn = liDir.querySelector('button.toggle');
  const ul  = liDir.querySelector('ul');
  const collapsed = ul.classList.contains('hidden');

  // ç¬¬ä¸€æ¬¡å±•é–‹æ‰æ‰“ API
  if (collapsed && ul.children.length === 0){
    const folderPath = liDir.dataset.fullPath || '';      // âœ… ç”¨ data-full-path
    try{
      const kids = await fetchDir(folderPath);
      for(const ent of kids){
        ul.appendChild(ent.type==='dir' ? renderClosedFolder(ent.path) : renderFile(ent.path, ent.name));
      }
    }catch(err){
      const errLi=document.createElement('li');
      errLi.innerHTML=`<span class="status">ç„¡æ³•è®€å–ï¼š${escapeHtml(err.message||String(err))}</span>`;
      ul.appendChild(errLi);
    }
    applyTreeFilters();
  }

  ul.classList.toggle('hidden');
  if(btn) btn.textContent = ul.classList.contains('hidden') ? 'â–¸' : 'â–¾';
});
  
function renderClosedFolder(fullPath){
  const li = document.createElement('li');
  li.className = 'node dir';
  li.dataset.fullPath = fullPath;            // âœ… å­˜å®Œæ•´è·¯å¾‘
  const head = document.createElement('div'); head.className='node';
  const btn  = document.createElement('button'); btn.className='toggle'; btn.textContent='â–¸';
  const span = document.createElement('span');   span.className='fname';  span.textContent='ğŸ“ '+ fullPath.split('/').pop();
  head.appendChild(btn); head.appendChild(span); li.appendChild(head);

  const ul = document.createElement('ul'); ul.className='hidden'; li.appendChild(ul);
  let loaded=false, collapsed=true;

  async function expand(){
    if(!loaded){
      try{
        const kids = await fetchDir(fullPath);              // âœ… ç”¨å®Œæ•´è·¯å¾‘
        for(const ent of kids){
          ul.appendChild(ent.type==='dir' ? renderClosedFolder(ent.path) : renderFile(ent.path, ent.name));
        }
        loaded = true;
        applyTreeFilters();
      }catch(err){
        const errLi=document.createElement('li');
        errLi.innerHTML=`<span class="status">ç„¡æ³•è®€å–ï¼š${escapeHtml(err.message||String(err))}</span>`;
        ul.appendChild(errLi);
      }
    }
    collapsed=false; btn.textContent='â–¾'; ul.classList.remove('hidden');
  }
  function collapse(){ collapsed=true; btn.textContent='â–¸'; ul.classList.add('hidden'); }

  btn.addEventListener('click', ()=> collapsed?expand():collapse());
  span.addEventListener('click', ()=> collapsed?expand():collapse());
  return li;
}
  
function renderFile(fullPath, name){
  const li=document.createElement('li'); li.className='node file'; li.dataset.fullPath=fullPath;
  const row=document.createElement('div'); row.className='node';
  const a=document.createElement('a'); a.href='#'; a.className='fname file'; a.textContent='ğŸ“„ '+name; a.title=fullPath;
  const badge=document.createElement('span'); badge.className='badge'; badge.textContent=extOf(name)||'file';
  row.appendChild(a); row.appendChild(badge); li.appendChild(row);
  a.addEventListener('click', e=>{ e.preventDefault(); openFileFromTree(fullPath,name); });
  return li;
}
function renderDirNode(path, entries){
  const li = document.createElement('li');
  li.className = 'node dir';
  li.dataset.fullPath = path || '';          // âœ… å­˜çœŸæ­£è·¯å¾‘ï¼ˆroot ç”¨ç©ºå­—ä¸²ï¼‰
  const header = document.createElement('div');
  header.className = 'node';
  const btn  = document.createElement('button'); btn.className='toggle'; btn.textContent='â–¾';
  const span = document.createElement('span');   span.className='fname';  span.textContent='ğŸ“ '+(path||'/');
  header.appendChild(btn); header.appendChild(span);
  li.appendChild(header);

  const ul = document.createElement('ul'); li.appendChild(ul);
  for(const ent of entries){
    if(ent.type==='dir') ul.appendChild(renderClosedFolder(ent.path));
    else                 ul.appendChild(renderFile(ent.path, ent.name));
  }

  let collapsed = false;
  btn.addEventListener('click', ()=>{
    collapsed = !collapsed;
    btn.textContent = collapsed ? 'â–¸' : 'â–¾';
    ul.classList.toggle('hidden', collapsed);
  });

  return li;
}
  
function applyTreeFilters(){
  const q=(nameFilter.value||'').toLowerCase();
  const items=treeRoot.querySelectorAll('li.node.file');
  items.forEach(li=>{
    const name=li.querySelector('.fname').textContent.toLowerCase();
    const okExt=showByExt(name); const okName=!q || name.includes(q);
    li.style.display=(okExt && okName) ? '' : 'none';
  });
}
function openFileFromTree(fullPath,name){
  pathEl.value=fullPath;
  const e=extOf(name);
  typeEl.value=(e==='srt'||e==='csv'||e==='docx'||e==='pdf')? e : 'srt';
  loadFile();
}
reloadTreeBtn.addEventListener('click',()=>loadTree(treePathEl.value.trim()));
ownerEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
repoEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
branchEl.addEventListener('change',()=>loadTree(treePathEl.value.trim()));
nameFilter.addEventListener('input', applyTreeFilters);
[showSRT,showCSV,showDOCX,showPDF,showOTHER].forEach(el=> el.addEventListener('change', applyTreeFilters));

/* ===== File renderers ===== */
let lastType=null; let srtEntries=[]; let csvData={header:[],rows:[]}; let docxHtmlOriginal='';
let pdfState = { doc:null, page:1, pages:0, scale:1.25, pageTexts:[] };

function highlightText(text, re){
  if(!re || text==null) return escapeHtml(text);
  const s=String(text); let out=''; let last=0; const r=new RegExp(re.source, re.flags);
  let m; while((m=r.exec(s))){
    out += escapeHtml(s.slice(last, m.index));
    out += `<mark>${escapeHtml(m[0])}</mark>`;
    last = m.index + m[0].length; if(!r.global) break;
  }
  out += escapeHtml(s.slice(last)); return out;
}

/* SRT */
function parseSrt(text){
  const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  const blocks = norm.split(/\n{2,}/); const entries=[];
  for(const b of blocks){
    const lines=b.trim().split('\n'); if(!lines[0]) continue;
    let idx=lines[0].trim(), timeLine='', textLines=[];
    if(/^\d+$/.test(idx) && lines.length>=2){ timeLine=lines[1].trim(); textLines=lines.slice(2); }
    else { idx=''; timeLine=lines[0].trim(); textLines=lines.slice(1); }
    let start='', end=''; const m=timeLine.match(/(\d{2}:\d{2}:\d{2},\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2},\d{3})/); if(m){ start=m[1]; end=m[2]; }
    entries.push({index:idx,start,end,text:textLines.join('\n')});
  } return entries;
}
function renderSrt(entries, re){
  let html = '<table><thead><tr><th>#</th><th>Start</th><th>End</th><th>Text</th></tr></thead><tbody>';
  for(const e of entries){
    html += `<tr><td>${escapeHtml(e.index||'')}</td><td>${escapeHtml(e.start)}</td><td>${escapeHtml(e.end)}</td><td><pre>${re?highlightText(e.text,re):escapeHtml(e.text)}</pre></td></tr>`;
  }
  html += '</tbody></table>'; resultEl.innerHTML=html;
}

/* CSV */
function parseCsv(text){
  const norm = String(text).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
  let lines = norm.split('\n');
  while(lines.length && lines[lines.length-1].trim()==='') lines.pop();
  if(lines.length && lines[0].charCodeAt(0)===65279) lines[0]=lines[0].slice(1); // BOM
  if(!lines.length) return {header:[],rows:[]};
  const header = splitCsvLine(lines[0]);
  const rows = lines.slice(1).map(splitCsvLine);
  return {header, rows};
}
function splitCsvLine(line){
  const out=[]; let cur=''; let inQ=false;
  for(let i=0;i<line.length;i++){
    const ch=line[i];
    if(inQ){
      if(ch==='"'){ if(i+1<line.length && line[i+1]=='"'){ cur+='"'; i++; } else inQ=false; }
      else cur+=ch;
    }else{
      if(ch==='"') inQ=true;
      else if(ch===','){ out.push(cur); cur=''; }
      else cur+=ch;
    }
  } out.push(cur); return out;
}
function renderCsv(header, rows, re){
  let html = '<table><thead><tr>'+header.map(h=>`<th>${escapeHtml(h)}</th>`).join('')+'</tr></thead><tbody>';
  for(const row of rows){
    html += '<tr>' + header.map((_,i)=>{ const cell=row[i]??''; return `<td>${re?highlightText(cell,re):escapeHtml(cell)}</td>`; }).join('') + '</tr>';
  }
  html += '</tbody></table>'; resultEl.innerHTML=html;
}

/* DOCX */
function restoreDocx(){ resultEl.innerHTML = docxHtmlOriginal; }

/* PDF */
function renderPdfUI(){
  resultEl.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <button id="pdfPrev">ä¸Šä¸€é </button>
      <button id="pdfNext">ä¸‹ä¸€é </button>
      <button id="pdfZoomOut">ç¸®å°</button>
      <button id="pdfZoomIn">æ”¾å¤§</button>
      <span id="pdfPageInfo" class="status"></span>
    </div>
    <div id="pdfCanvasWrap"><canvas id="pdfCanvas"></canvas></div>
  `;
  $("pdfPrev").onclick = ()=>{ if(pdfState.page>1){ pdfState.page--; renderPdfPage(); } };
  $("pdfNext").onclick = ()=>{ if(pdfState.page<pdfState.pages){ pdfState.page++; renderPdfPage(); } };
  $("pdfZoomOut").onclick = ()=>{ pdfState.scale = Math.max(0.5, pdfState.scale-0.25); renderPdfPage(); };
  $("pdfZoomIn").onclick = ()=>{ pdfState.scale = Math.min(3, pdfState.scale+0.25); renderPdfPage(); };
}
async function renderPdfPage(){
  const page = await pdfState.doc.getPage(pdfState.page);
  const viewport = page.getViewport({scale: pdfState.scale});
  const canvas = $("pdfCanvas"); const ctx = canvas.getContext('2d');
  canvas.width = viewport.width; canvas.height = viewport.height;
  await page.render({canvasContext: ctx, viewport}).promise;
  $("pdfPageInfo").textContent = `é  ${pdfState.page} / ${pdfState.pages}ï¼ˆç¸®æ”¾ ${pdfState.scale.toFixed(2)}xï¼‰`;
}
async function extractPdfTexts(){
  pdfState.pageTexts = new Array(pdfState.pages+1).fill("");
  for(let p=1; p<=pdfState.pages; p++){
    const page = await pdfState.doc.getPage(p);
    const tc = await page.getTextContent();
    pdfState.pageTexts[p] = tc.items.map(i=>i.str).join(" ");
  }
}

/* ===== Dispatcher ===== */
loadBtn.addEventListener('click', loadFile);
qEl.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
searchBtn.addEventListener('click', doSearch);
clearBtn.addEventListener('click', ()=>{ qEl.value=''; doSearch(); });

async function loadFile(){
  const rel=(pathEl.value||'').trim();
  if(!rel){ statusEl.innerHTML='<span class="error">è«‹è¼¸å…¥æª”æ¡ˆè·¯å¾‘ã€‚</span>'; return; }
  const base=rawBase(); const full=encodeURI(base.url + rel);
  let type=typeEl.value; const lower=rel.toLowerCase();
  if(lower.endsWith('.srt')) type='srt';
  else if(lower.endsWith('.csv')) type='csv';
  else if(lower.endsWith('.docx')) type='docx';
  else if(lower.endsWith('.pdf')) type='pdf';
  typeEl.value = type;

  statusEl.textContent=`è¼‰å…¥ä¸­ï¼š${full}`; countsEl.textContent=''; resultEl.innerHTML=''; pdfResultsEl.innerHTML='';
  try{
    if(type==='docx'){
      const res=await fetch(full); if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const buf=await res.arrayBuffer();
      const out=await window.mammoth.convertToHtml({arrayBuffer:buf});
      lastType='docx'; docxHtmlOriginal = `<div class="docx-content">${out.value}</div>`; resultEl.innerHTML=docxHtmlOriginal;
    }else if(type==='pdf'){
      const doc = await pdfjsLib.getDocument({ url: full }).promise;
      pdfState.doc = doc; pdfState.pages = doc.numPages; pdfState.page = 1; pdfState.scale = 1.25;
      lastType='pdf'; renderPdfUI(); await renderPdfPage(); await extractPdfTexts();
    }else{
      const res=await fetch(full); if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const text=await res.text();
      if(type==='srt'){ lastType='srt'; srtEntries=parseSrt(text); renderSrt(srtEntries); }
      else if(type==='csv'){ lastType='csv'; csvData=parseCsv(text); renderCsv(csvData.header, csvData.rows); }
    }
    const ghUrl=`https://github.com/${base.o}/${base.r}/blob/${base.b}/${rel}`;
    statusEl.innerHTML=`è¼‰å…¥å®Œæˆï¼š<a href="${full}" target="_blank" rel="noopener">Raw</a> Â· <a href="${ghUrl}" target="_blank" rel="noopener">GitHub</a>`;
    doSearch();
  }catch(e){
    statusEl.innerHTML=`<span class="error">è¼‰å…¥å¤±æ•—ï¼š${escapeHtml(e.message||String(e))}</span>`;
  }
}

/* ===== Search ===== */
function doSearch(){
  const q=qEl.value.trim(); const re=buildRegex(q); countsEl.textContent=''; pdfResultsEl.innerHTML='';
  if(lastType==='srt'){
    let data=srtEntries;
    if(re && filterRowsEl.checked){
      data = srtEntries.filter(e=>{
        const r=new RegExp(re.source, re.flags);
        return r.test(e.text)||r.test(e.start)||r.test(e.end);
      });
    }
    renderSrt(data, re);
    countsEl.textContent = re ? `å­—å¹•æ®µè½ï¼š${data.length} ï¼Œé«˜äº®æ¬¡æ•¸ï¼šç´„ ${data.reduce((a,e)=>a+countMatches(e.text,re),0)}` : `å­—å¹•æ®µè½ï¼š${data.length}`;
  }
  else if(lastType==='csv'){
    let rows=csvData.rows;
    if(re && filterRowsEl.checked){ rows = csvData.rows.filter(r=> r.some(c=> (new RegExp(re.source, re.flags)).test(String(c)))); }
    renderCsv(csvData.header, rows, re);
    if(re){
      let hits=0; for(const r of rows){ for(const c of r){ hits += countMatches(c,re); } }
      countsEl.textContent=`åˆ—æ•¸ï¼š${rows.length} ï¼Œé«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}`;
    }else countsEl.textContent=`åˆ—æ•¸ï¼š${rows.length}`;
  }
  else if(lastType==='docx'){
    restoreDocx(); const root=resultEl.firstElementChild||resultEl;
    const hits = re ? highlightInElement(root, re) : 0;
    countsEl.textContent = re ? `é«˜äº®æ¬¡æ•¸ï¼šç´„ ${hits}` : '';
  }
  else if(lastType==='pdf'){
    if(!re || !pdfState.pageTexts.length){ countsEl.textContent=''; pdfResultsEl.textContent=''; return; }
    let total=0; const items=[];
    for(let p=1; p<=pdfState.pages; p++){
      const text = pdfState.pageTexts[p] || "";
      const r = new RegExp(re.source, re.flags); let m; let idxs=[];
      while((m=r.exec(text))){ idxs.push({i:m.index, len:m[0].length}); if(!r.global) break; }
      total += idxs.length;
      for(const it of idxs){
        const start = Math.max(0, it.i-30), end = Math.min(text.length, it.i+it.len+30);
        const pre=text.slice(start, it.i), mid=text.slice(it.i, it.i+it.len), post=text.slice(it.i+it.len, end);
        const snip = `${escapeHtml(pre)}<mark>${escapeHtml(mid)}</mark>${escapeHtml(post)}`;
        items.push({p, snip});
      }
    }
    countsEl.textContent = `PDF å‘½ä¸­æ¬¡æ•¸ï¼šç´„ ${total}ï¼ˆ${pdfState.pages} é ï¼‰`;
    pdfResultsEl.innerHTML = items.slice(0,300).map(it=>`<a href="#" data-page="${it.p}">ç¬¬ ${it.p} é ï¼šâ€¦ ${it.snip} â€¦</a>`).join("") || 'ï¼ˆæ²’æœ‰æ‰¾åˆ°é—œéµå­—ï¼‰';
    pdfResultsEl.querySelectorAll('a').forEach(a=>{
      a.addEventListener('click', e=>{ e.preventDefault(); pdfState.page=Number(a.dataset.page)||1; renderPdfPage(); });
    });
  }
}

/* DOCX highlighter */
function highlightInElement(root, re){
  if(!re) return 0; let cnt=0;
  const walker=document.createTreeWalker(root, NodeFilter.SHOW_TEXT); const nodes=[];
  while(walker.nextNode()) nodes.push(walker.currentNode);
  for(const node of nodes){
    const s=node.nodeValue; const r=new RegExp(re.source, re.flags); if(!r.test(s)) continue; r.lastIndex=0;
    const frag=document.createDocumentFragment(); let last=0; let m;
    while((m=r.exec(s))){
      if(m.index>last) frag.appendChild(document.createTextNode(s.slice(last, m.index)));
      const mark=document.createElement('mark'); mark.textContent=m[0]; frag.appendChild(mark);
      last = m.index + m[0].length; cnt++; if(!r.global) break;
    }
    if(last<s.length) frag.appendChild(document.createTextNode(s.slice(last)));
    node.parentNode.replaceChild(frag, node);
  }
  return cnt;
}

/* init */
loadTree('');

const showAllBtn = document.getElementById('showAllBtn');
if(showAllBtn){
  showAllBtn.addEventListener('click', ()=>{
    showSRT.checked = showCSV.checked = showDOCX.checked = showPDF.checked = showOTHER.checked = true;
    nameFilter.value = '';
    applyTreeFilters();
  });
}

</script>
</body>
</html>
